name: sungather
summary: Data collection tool for Sungrow solar inverters
description: |
  SunGather collects operational data from Sungrow inverters via ModBus
  connections and exports to MQTT, InfluxDB, PVOutput.org, and more.
version: "0.3.8"
base: ubuntu@22.04
build-base: ubuntu@22.04
platforms:
  amd64:

services:
  sungather:
    override: replace
    startup: enabled
    command: /opt/venv/bin/python3.10 /opt/sungather/SunGather/sungather.py -c /config/config.yaml
    environment:
      PYTHONUNBUFFERED: "1"

parts:
  sungather:
    plugin: nil
    build-packages:
      - git
      - curl
    build-snaps:
      - astral-uv
    stage-packages:
      - python3.10
      - python3-pkg-resources
    override-build: |
      # Clone SunGather repository
      git clone https://github.com/bohdan-s/SunGather.git /tmp/sungather-src
      cd /tmp/sungather-src

      # Create virtual environment with uv
      uv venv ${CRAFT_PART_INSTALL}/opt/venv --python python3.10

      # Install Python dependencies with uv
      uv pip install -r requirements.txt --python ${CRAFT_PART_INSTALL}/opt/venv/bin/python

      # Copy SunGather application files
      mkdir -p ${CRAFT_PART_INSTALL}/opt/sungather
      cp -r SunGather requirements.txt setup.py README.md LICENSE ${CRAFT_PART_INSTALL}/opt/sungather/

      # Update the Python shebang if sungather.py exists
      if [ -f "${CRAFT_PART_INSTALL}/opt/sungather/SunGather/sungather.py" ]; then
        sed -i '1s|^#!/usr/bin/env python3|#!/opt/venv/bin/python3.10|' ${CRAFT_PART_INSTALL}/opt/sungather/SunGather/sungather.py
      fi
