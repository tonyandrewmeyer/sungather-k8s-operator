name: sungather
summary: Data collection tool for Sungrow solar inverters
description: |
  SunGather collects operational data from Sungrow inverters via ModBus
  connections and exports to MQTT, InfluxDB, PVOutput.org, and more.
version: "0.3.8"
base: ubuntu@22.04
build-base: ubuntu@22.04
platforms:
  amd64:

services:
  sungather:
    override: replace
    startup: enabled
    command: /usr/bin/python3.10 sungather.py -c /config/config.yaml
    working-dir: /opt/sungather/SunGather
    environment:
      PYTHONUNBUFFERED: "1"
      PYTHONPATH: "/opt/sungather-lib"

parts:
  sungather:
    plugin: nil
    build-packages:
      - git
      - curl
    build-snaps:
      - astral-uv
    stage-packages:
      - python3.10
      - python3-pkg-resources
    override-build: |
      # Clone SunGather repository
      git clone https://github.com/bohdan-s/SunGather.git /tmp/sungather-src
      cd /tmp/sungather-src

      # Install Python dependencies to a custom location using uv
      mkdir -p ${CRAFT_PART_INSTALL}/opt/sungather-lib
      uv pip install -r requirements.txt --target ${CRAFT_PART_INSTALL}/opt/sungather-lib --python /usr/bin/python3.10

      # Copy SunGather application files
      mkdir -p ${CRAFT_PART_INSTALL}/opt/sungather
      cp -r SunGather requirements.txt setup.py README.md LICENSE ${CRAFT_PART_INSTALL}/opt/sungather/

      # Update the Python shebang if sungather.py exists
      if [ -f "${CRAFT_PART_INSTALL}/opt/sungather/SunGather/sungather.py" ]; then
        sed -i '1s|^#!/usr/bin/env python3|#!/usr/bin/python3.10|' ${CRAFT_PART_INSTALL}/opt/sungather/SunGather/sungather.py
      fi
