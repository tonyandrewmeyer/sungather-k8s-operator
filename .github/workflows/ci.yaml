name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'

      - name: Install tox
        run: uv tool install --with=tox-uv tox

      - name: Run linting
        run: uv run tox -e lint

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'

      - name: Install tox
        run: uv tool install --with=tox-uv tox

      - name: Run unit tests
        run: uv run tox -e unit

  build-rock:
    name: Build and Push Rock
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      packages: write
    outputs:
      rock-image: ${{ steps.metadata.outputs.image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rockcraft
        run: sudo snap install rockcraft --classic

      - name: Build rock
        run: |
          cd rock
          sudo rockcraft pack --destructive-mode --verbose

      - name: Extract rock to OCI archive
        id: extract
        run: |
          cd rock
          ROCK_FILE=$(ls *.rock)
          sudo rockcraft.skopeo --insecure-policy copy oci-archive:${ROCK_FILE} docker-archive:sungather.tar
          sudo chown $USER:$USER sungather.tar
          echo "archive=rock/sungather.tar" >> $GITHUB_OUTPUT

      - name: Generate image metadata
        id: metadata
        run: |
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/sungather"
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            TAG="${IMAGE_NAME}:pr-${{ github.event.pull_request.number }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            TAG="${IMAGE_NAME}:latest"
          else
            TAG="${IMAGE_NAME}:${{ github.sha }}"
          fi
          echo "image=${TAG}" >> $GITHUB_OUTPUT
          echo "Building image: ${TAG}"

      - name: Load and push image
        run: |
          LOADED_ID=$(docker load < ${{ steps.extract.outputs.archive }} | grep -oP 'sha256:[a-f0-9]+')
          docker tag ${LOADED_ID} ${{ steps.metadata.outputs.image }}
          docker push ${{ steps.metadata.outputs.image }}

      - name: Upload rock artifact
        uses: actions/upload-artifact@v6
        with:
          name: rock
          path: rock/*.rock

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build-rock
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'

      - name: Install Concierge
        run: |
          sudo apt-get remove -y docker-ce docker-ce-cli containerd.io
          sudo rm -rf /run/containerd
          sudo snap install concierge --classic

      - name: Set up development environment
        run: sudo concierge prepare -p dev

      - name: Install tox
        run: uv tool install --with=tox-uv tox

      - name: Pack charm
        run: |
          sudo charmcraft pack --destructive-mode
          sudo chown -R $USER:$USER .

      - name: Run integration tests
        run: uv run tox -e integration
        env:
          CHARM_PATH: ${{ github.workspace }}/sungather-k8s_amd64.charm

      - name: Upload charm artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: charm
          path: '*.charm'

      - name: Collect debug logs
        if: failure()
        run: |
          juju debug-log --replay --no-tail > debug-log.txt
          juju status --format=yaml > status.yaml

      - name: Upload debug logs
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: debug-logs
          path: |
            debug-log.txt
            status.yaml
